# 6.4 Mixtures Analysis Methods Part 2: Bayesian Kernel Machine Regression 

This training module was developed by Dr. Lauren Eaves, Dr. Kyle Roell, and Dr. Julia E. Rager.

All input files (script, data, and figures) can be downloaded from the [UNC-SRP TAME2 GitHub website](https://github.com/UNCSRP/TAME2).


```{r , include=FALSE}
#set default values for R Markdown "knitting" to HTML, Word, or PDF
knitr::opts_chunk$set(echo = TRUE) #print code chunks
```


## Introduction to Training Module 

In this training module, we will continue to explore mixtures analysis method, this time with a scripted example of Bayesian Kernel Machine Regression (BKMR). Please refer to **TAME 2.0 Module 6.3, Mixtures Analysis Methods Part 1: Overview and Example with Quantile G-Computation** for an overview of mixtures methodologies and a scripted example using Quantile g-Computation. 

## Introduction to Example Data

In this scripted example, we will use a dataset from the [Extremely Low Gestational Age Newborn (ELGAN) cohort](https://elgan.fpg.unc.edu/). Specifically, we will analyze metal mixtures assessed in cord tissue collected at delivery with neonatal inflammation measured over the first two weeks of life. 

For more information on the cord tissue metals data, please see the following two publications:

 + Eaves LA, Bulka CM, Rager JE, Galusha AL, Parsons PJ, O’Shea TM and Fry RC. [Metals mixtures modeling identifies birth weight-associated gene networks in the placentas of children born extremely preterm](https://pubmed.ncbi.nlm.nih.gov/36493891/). Chemosphere. 2022;137469. doi:10.1016/j.chemosphere.2022.137469.
 + Bulka CM, Eaves LA, Gardner AJ, Parsons PJ, Kyle RR, Smeester L, O"Shea TM, Fry RC. [Prenatal exposure to multiple metallic and metalloid trace elements and the risk of bacterial sepsis in extremely low gestational age newborns: A prospective cohort study](https://pubmed.ncbi.nlm.nih.gov/36405975/). Front Epidemiol. 2022;2. doi:10.3389/fepid.2022.958389
 
For more information on the neonatal inflammation data, please see the following publication: 

 + Eaves LA, Enggasser AE, Camerota M, Gogcu S, Gower WA, Hartwell H, Jackson WM, Jensen E, Joseph RM, Marsit CJ, Roell K, Santos HP Jr, Shenberger JS, Smeester L, Yanni D, Kuban KCK, O'Shea TM, Fry RC. [CpG methylation patterns in placenta and neonatal blood are differentially associated with neonatal inflammation](https://pubmed.ncbi.nlm.nih.gov/35764815/). Pediatr Res. June 2022. doi:10.1038/s41390-022-02150-4
 
Here, we have a dataset of n=254 participants for which we have complete data on neonatal inflammation, cord tissue metals and key demographic variables that will be included as confounders in the analysis.

Extensive research in the ELGAN study has demonstrated that neonatal inflammation is predictive of cerebral palsy, ASD, ADHD, obesity, cognitive impairment, attention problems,cerebral white matter damage, and decreased total brain volume, among other adverse outcomes. Therefore identifying exposures that lead to neonatal inflammation and could be intervened upon to reduce the risk of neonatal inflammation is critical to improve neonatal health. Environmental exposures during pregnancy such as metals may contribute to neonatal inflammation. As is often the case in environmental health, these chemical exposures are likely co-occurring and therefore mixtures methods are needed. 

## Introduction to BKMR

BKMR offers a flexible, non-parametric method to estimate:

1) The single exposure effect: odds ratio of inflammation when a single exposure is at its 75th percentile compared to its 25th percentile, with other exposures at their 50th percentile and covariates held constant
2) The overall mixture effect: odds ratio of inflammation when all exposures are fixed at their 75th percentile compared to when all of the factors are fixed to their 25th percentile; 
3) The interactive effect: the difference in the single-exposure effect when all of the other exposures are fixed at their 75th percentile, as compared to when all of the other factors are fixed at their 25th percentile; 


There are numerous excellent summaries of BKMR, including the publications in which it was first introduced: 

 + Bobb et al. [Bayesian kernel machine regression for estimating the health effects of multi-pollutant mixtures](https://academic.oup.com/biostatistics/article/16/3/493/269719)
 + Bobb et al. [Statistical software for analyzing the health effects of multiple concurrent exposures via Bayesian kernel machine regression](https://ehjournal.biomedcentral.com/articles/10.1186/s12940-018-0413-y) 

And other vignettes and toolkits including:

 + Jennifer Bobb's [Introduction to Bayesian kernel machine regression and the bkmr R package](https://jenfb.github.io/bkmr/overview.html) 
 + Andrea Bellavia's [Bayesian kernel machine regression](https://bookdown.org/andreabellavia/mixtures/bayesian-kernel-machine-regression.html) 
 

While BKMR can do many things other methods cannot, it can require a lot of computational resources and take a long time to run. Before working with your final dataset and analysis, if very large or complex, it is often recommended to start with a smaller sample to make sure everything is working correctly before starting an analysis that make takes days to complete. 


### Training Module's **Environmental Health Questions**
This training module was specifically developed to answer the following questions, which mirror the questions in **TAME 2.0 Module 6.3**, but are just in a different order:

1. Which of these chemicals has the strongest effect on neonatal inflammation risk?
2. Which of these chemicals increases the risk of neonatal inflammation and which decreases the risk of neonatal inflammation?
3. What is the risk of neonatal inflammation associated with exposure to each of manganese, copper, zinc, arsenic, selenium, cadmium, mercury, lead individually?
4. What is the risk of neonatal inflammation  associated with combined exposure to manganese, copper, zinc, arsenic, selenium, cadmium, mercury, lead (ie. a mixture)?
and in addition to the questions addressed in Mixtures Methods 1, we additionally can answer:
5. Are there interactions among manganese, copper, zinc, arsenic, selenium, cadmium, mercury, lead in relation to neonatal inflammation?

## Run BKMR

### Workspace Preparation

Install packages as needed, then load the following packages:
```{r cars, message = FALSE}
#load packages
library(tidyverse)
library(ggplot2)
library(knitr)
library(yaml)
library(rmarkdown)
library(broom)
library(ggpubr)
library(bkmr)
```

Optionally, you can also create a current date variable to name output files, and create an output folder. 
```{r eval = FALSE}
#Create a current date variable to name outputfiles
cur_date <- str_replace_all(Sys.Date(),"-","")

#Create an output folder 
Output_Folder <- ("Module6_4_Output/")
```

### Data Import
```{r}
cohort <- read.csv(file="Module6_4_Input/Module6_4_InputData.csv")
colnames(cohort)
head(cohort)
```

The variables in this dataset include sample and demographic information and cort tissue metal exposure in $mu$g/g or ng/g. 

*Sample and Demographic Variables*

+ "id": unique study ID  
 outcome:
+ "inflam_intense": 1= high inflammation, 0=low inflammation 
 covariates: 
+ "race1": maternal race, 1=White, 2=Black, 0=Other          
+ "sex": neonatal sex, 0=female, 1=male           
+ "gadays": gestational age at delivery in days         
+ "magecat": maternal age, 1= <21, 2=21-35, 3= > 35  
+ "medu":maternal education: 1= <12, 2=12, 3=13-15, 4=16, 5= >16        
+ "smoke": maternal smoking while pregnant, 0=no, 1=yes 

*Exposure Variables*

+ "Mn_ugg"         
+ "Cu_ugg"         
+ "Zn_ugg"        
+ "As_ngg"         
+ "Se_ugg"         
+ "Cd_ngg"         
+ "Hg_ngg"        
+ "Pb_ngg"     


There are many steps prior to the modeling steps outlined below. These are being skipped for educational purposes. Additional steps include assessment of normality and transformations as needed, generation of a demographics table and assessing for missing data, imputation of missing data if needed, visualizing trends and distributions in the data, assessing correlations between exposures, functional form assessments, and decisions regarding what confounders to include.

In addition, it is highly recommended to conduct single-contaminant modeling initially to understand individual chemical relationships with the outcomes of focus before conducting mixtures assessment. For an example of this, see **TAME 2.0 Module 6.3, Mixtures Analysis Methods Part 1: Overview and Example with Quantile G-Computation**. BKMR, as a flexible non-parametric modeling approach, does not allow for classical null-hypothesis testing, and 95% CI are interpreted as credible intervals, not confidence intervals. One approach therefore could be to explore non-linearities and interactions within BKMR to then validate generated hypotheses using quantile g-computation. 

### Fit the BKMR Model
First, define a matrix/vector of the exposure mixture, outcome, and confounders/covariates. BKMR performs better when the exposures are on a similar scale and when there are not outliers. Thus, we center and scale the exposure variables first. As noted above, in a complete analysis, thorough examination of exposure variable distributions, including outliers and normality, would be conducted before any exposure-outcome modeling. For more information on normality testing, see **TAME 2.0 Module 3.3, Normality Tests and Data Transformations.** 

First, we'll assign the matrix variables to their own data frame and scale the data.
```{r, message=F, warning=F, error=F}
#exposure mixture variables
mixture <- as.matrix(cohort[,10:17])
mixture <- log(mixture)
mixture <-scale(mixture, center=TRUE)
summary(mixture)
```

Then, we'll define the outcome variable and ensure it is the proper class and leveling.
```{r}
#outcome variable
cohort$inflam_intense  <-as.factor(cohort$inflam_intense)
cohort$inflam_intense <- relevel(cohort$inflam_intense, ref = "0")
y<-as.numeric(as.character(cohort$inflam_intense))
```

Next, we'll assign the covariates to a matrix. 
```{r}
#covariates
covariates<-as.matrix(cohort[,7:9])
```

Then, we can fit the BKMR model. Note that this script will take a few minutes to run. 
```{r}
set.seed(111)
fitkm <- kmbayes(y = y, Z = mixture, X = covariates, iter = 5000, verbose = FALSE, varsel = TRUE, family="binomial", est.h = TRUE)
```

For full information regarding options for the kmbayes function, refer to the BKMR reference manual: https://cran.r-project.org/web/packages/bkmr/bkmr.pdf 
 
### Assess Variable Importance  
BKMR conducts a variable selection procedure and generates posterior inclusion probabilities (PIP). The larger the PIP, the more a variable is contributing to the overall exposure-outcome effect. These are relative to each other,so there is no threshold as to when a variable becomes an "important" contributor (similar to the weights in quantile g-computation). 
```{r, message=F, warning=F, error=F}
ExtractPIPs(fitkm)
```

Relative to each other, the contributions to the effect of the mixture on neonatal inflammation are shown above for each component of the mixture. Note that if a variable PIP=0, BKMR will drop it from the model and the overall mixture effect will not include this exposure. 

### Answer to Environmental Health Question 1
:::question
*With this, we can answer **Environmental Health Question #1***: Which of these chemicals has the strongest effect on neonatal inflammation risk?
:::

:::answer
**Answer**: Based on the PIPs: Cadmium.
:::


### Assess Model Convergence 

We can use trace plots to evaluate how the parameters in the model converge over the many iterations. We hope to see that the line moves randomly but centers around a straight line 

```{r, message=F, warning=F, error=F, fig.align = "center"}
sel<-seq(0,5000,by=1)
TracePlot(fit = fitkm, par = "beta", sel=sel)
```

Based on this plot, it looks like the burn in period is roughly 1000 iterations. We will remove these from the results. 
```{r, message=F, warning=F, error=F, fig.align = "center"}
sel<-seq(1000,5000,by=1)
TracePlot(fit = fitkm, par = "beta", sel=sel)
```

### Presenting Model Results 

#### Single exposure effects
As described above, one way to examine single effects is to calculate the odds ratio of inflammation when a single exposure is at its 75th percentile compared to its 25th percentile, with other exposures are at their 50th percentile and covariates are held constant.

Here, we use the `PredictorResponseUnivar()` function to generate a dataset that details, at varying levels of each exposure ("z"), the relationship between that exposure and the outcome, holding other exposures at their 50th percentile and covariates constant. This relationship is given by a beta value, which because we have a binomial outcome and fit a probit model represents the log(odds) ("est"). The standard error for the beta value is also calculated ("se"). 

```{r, message=F, warning=F, error=F, fig.align = "center"}
pred.resp.univar <- PredictorResponseUnivar(fit=fitkm, sel=sel, 
                                            method="approx", q.fixed = 0.5)

head(pred.resp.univar)
```

We can then plot these data for each exposure to visualize the exposure-response function for each exposure. 

```{r}
ggplot(pred.resp.univar, aes(z, est, ymin = est - 1.96*se, 
                             ymax = est + 1.96*se)) + 
  geom_smooth(stat = "identity") + ylab("h(z)") + facet_wrap(~ variable) 
```

Then, we can generate a dataset that contains for each exposure ("variable"), the log(OR) ("est") (and its standard deviation ("sd")) corresponding to the odds of neonatal inflammation when an exposure is at its 75th compared to the odds when at the 25th percentile. The log(OR) is estimated at three levels of the other exposures (25th, 50th and 75th percentiles). We can use this dataset to identify odds ratios for neonatal inflammation (comparing the 75th to 25th percentile odds) for each exposure at differing levels of the other exposures. These odds ratios approximate risk, whereby an odds ratio >1 means there is increased risk of neonatal inflammation when that exposure is at its 75th percentile compared to its 25th percentile. We can then plot these data to see the logOR for each metal in relation to neonatal inflammation at varying levels of the rest of the exposures. 

```{r, message=F, warning=F, error=F, fig.align = "center"}
risks.singvar <- SingVarRiskSummaries(fit=fitkm, qs.diff = c(0.25, 0.75),
                                      q.fixed = c(0.25, 0.50, 0.75), 
                                      method = "approx")

ggplot(risks.singvar, aes(variable, est, ymin = est - 1.96*sd,  
                          ymax = est + 1.96*sd, col = q.fixed)) + 
       geom_hline(aes(yintercept=0), linetype="dashed", color="gray") +  
       geom_pointrange(position = position_dodge(width = 0.75)) +
       coord_flip() + theme(legend.position="none")+scale_x_discrete(name="") +
       scale_y_continuous(name="estimate") 

```



### Answer to Environmental Health Question 2
:::question
*With this, we can answer  **Environmental Health Question #2***: Which of these chemicals increases the risk of neonatal inflammation and which decreases the risk of neonatal inflammation?
:::

:::answer
**Answer**: At all levels of the other exposures, lead, cadmium, selenium, arsenic and zinc reduce the odds of neonatal inflammation, while manganese and mercury appear to increase the odds of neonatal inflammation. Copper appears has a null effect. Notice that the credibility intervals however for all metals span the null meaning we are not confident in the independent effect of any of the metals.
:::


### Answer to Environmental Health Question 3
:::question
*With this, we can also answer also **Environmental Health Question #3***: What is the risk of neonatal inflammation associated with exposure to each of manganese, copper, zinc, arsenic, selenium, cadmium, mercury, lead individually?
:::

:::answer
**Answer**: As an example, take manganese: when all other exposures are at their 50th percentile, the log(OR) for Mn comparing being at the 75th to the 25th percentile is 0.024, which equals an odds ratio of 1.02. From this, you should be able to calculate the odds ratios for the other metals yourself.
:::


#### Calculating the overall mixture effect 

Next, we can generate a dataset that details the effect (ie. log(OR) ("est") and corresponding standard deviation ("sd")) on neonatal inflammation of all exposures when at a particular quantile ("quantile") compared to all exposures being at the 50th percentile. We can use this dataset to identify odds ratios for neonatal inflammation upon simultaneous exposure to the entire mixture for different quantile threshold comparisons. These odds ratios approximate risk, whereby an odds ratio >1 means there is increased risk of neonatal inflammation when the entire mixture is set at the index quantile, compared to the 50th percentile. We can also plot these results to visualize the overall mixture effect dose-response relationship. 

```{r, message=F, warning=F, error=F, fig.align = "center"}
risks.overall <- OverallRiskSummaries(fit=fitkm, qs=seq(0.25, 0.75, by=0.05), 
                                      q.fixed = 0.5, method = "approx",
                                      sel=sel)

ggplot(risks.overall, aes(quantile, est, ymin = est - 1.96*sd, 
                          ymax = est + 1.96*sd)) +  
  geom_hline(yintercept=00, linetype="dashed", color="gray") + 
  geom_pointrange() + scale_y_continuous(name="estimate") 
```


### Answer to Environmental Health Question 4
:::question
*With this, we can answer **Environmental Health Question #4***: What is the risk of neonatal inflammation  associated with combined exposure to manganese, copper, zinc, arsenic, selenium, cadmium, mercury, lead (ie. a mixture)?
:::

:::answer
**Answer**: When every exposure is at its 25th percentile concentration compared to their 50th percentile concentration, the odds ratio for neonatal inflammation is 1.11 (exp(0.10073680)). When every exposure is at its 75th percentile concentration compared to their 50th percentile concentration, the odds ratio for neonatal inflammation is 0.87 (exp(-0.12000889)).
:::


### Evaluating interactive effects  

To understand bivariate interactions, we can generate a dataset that for each pairing of exposures details at varying levels of both exposures, the log(odds) ("est", and associated standard deviation ("sd")) of neonatal inflammation when all the other exposures are held constant. These plots can be tricky to interpret, so another way of looking at these results is to take "cross sections" at specific quantiles of the second exposure (see next step). 
```{r, message=F, warning=F, error=F, fig.align = "center"}
pred.resp.bivar  <- PredictorResponseBivar(fit=fitkm,  min.plot.dist = 1, 
                                           sel=sel,  method="approx")

ggplot(pred.resp.bivar, aes(z1, z2, fill = est)) + 
  geom_raster() + 
  facet_grid(variable2 ~ variable1) +
  scale_fill_gradientn(colours=c("#0000FFFF","#FFFFFFFF","#FF0000FF")) +
  xlab("expos1") +
  ylab("expos2") +
  ggtitle("h(expos1, expos2)")
```

Next, we generate a dataset that includes for each pairing of exposures, the log(odds) ("est" and associated standard deviation "sd") of neonatal inflammation at varying concentrations ("z1") of the first exposure ("variable 1") when the second exposure ("variable 2" is at its 25th, 50th and 75th percentile ("quantile"). 

```{r, message=F, warning=F, error=F, fig.align = "center"}
pred.resp.bivar.levels <- PredictorResponseBivarLevels(pred.resp.df= 
                        pred.resp.bivar,   Z = mixture, both_pairs=TRUE, 
                        qs = c(0.25, 0.5, 0.75))

ggplot(pred.resp.bivar.levels, aes(z1, est)) + 
  geom_smooth(aes(col = quantile), stat = "identity") + 
 facet_grid(variable2 ~ variable1) +
  ggtitle("h(expos1 | quantiles of expos2)") +
 xlab("expos1")
```

There is evidence of an interactive effect between two exposures when the exposure-response function for exposure 1 varies in form between the different quantiles of exposure 2. You can also zoom in on one plot, for example: 

```{r, message=F, warning=F, error=F, fig.align = "center"}
HgCd <- pred.resp.bivar.levels %>% 
  filter(variable1=="Hg_ngg") %>% 
  filter(variable2=="Cd_ngg")

ggplot(HgCd, aes(z1, est)) + 
  geom_smooth(aes(col = quantile), stat = "identity") + 
  ggtitle("h(expos1 | quantiles of expos2)") +
 xlab("expos1")


CdHg <- pred.resp.bivar.levels %>% 
  filter(variable1=="Cd_ngg") %>% 
  filter(variable2=="Hg_ngg")

ggplot(CdHg, aes(z1, est)) + 
  geom_smooth(aes(col = quantile), stat = "identity") + 
  ggtitle("h(expos1 | quantiles of expos2)") +
 xlab("expos1")
```

To visualize interactions between one exposure and the rest of the exposure components, we generate a dataset that details the difference in each exposure's ("variable") log(OR) comparing 75th to 25th percentile ("est", and associated standard deviation "sd") when the other exposure components are at their 75th versus 25th percentile. Perhaps more intuitively, these estimates represent the blue - red points plotted in the second figure under the single exposure effects section. 
```{r, message=F, warning=F, error=F, fig.align = "center"}

risks.int <- SingVarIntSummaries(fit=fitkm, qs.diff = c(0.25, 0.75),
                                 qs.fixed = c(0.25, 0.75))


ggplot(risks.int, aes(variable, est, ymin = est - 1.96*sd, 
                      ymax = est + 1.96*sd)) + 
  geom_pointrange(position = position_dodge(width = 0.75)) + 
  geom_hline(yintercept = 0, lty = 2, col = "brown") + coord_flip()
```


### Answer to Environmental Health Question 5
:::question
*With this, we can answer **Environmental Health Question #5***: Are there interactions among manganese, copper, zinc, arsenic, selenium, cadmium, mercury, lead in relation to neonatal inflammation?
:::

:::answer
**Answer**: There do not appear to be any single exposure and rest of mixture interactions (previous plot); however, there is suggestive evidence of a bivariate interaction between cadmium and mercury.
:::


## Concluding Remarks
In conclusion, this module extends upon **TAME 2.0 Module 6.3, Mixtures Analysis Methods Part 1: Overview and Example with Quantile G-Computation**. In this scripted example, we used a dataset from a human population study (n=246) of cord tissue metals and examined the outcome of neonatal inflammation. We found that increasing the entire mixture of metals reduced the risk of neonatal inflammation; however, certain metals increased the risk and others decreased the risk. There was also a suggestive interactive effect found between cadmium and mercury. 

## Additional Resources
The field of mixtures is vast, with many different approaches and example studies to learn from as analysts lead in their own analyses. Some resources that can be helpful include the following reviews:

+ Our recent review on mixtures methodologies, particularly in the field of sufficient similarity, titled [Wrangling whole mixtures risk assessment: Recent advances in determining sufficient similarity](https://www.sciencedirect.com/science/article/abs/pii/S2468202023000323?via%3Dihub)
+ Two more general, epidemiology-focused reviews on mixtures questions and methodologies, titled [Complex Mixtures, Complex Analyses: an Emphasis on Interpretable Results](https://link.springer.com/article/10.1007/s40572-019-00229-5) and [Environmental exposure mixtures: questions and methods to address them](https://pubmed.ncbi.nlm.nih.gov/30643709/) 
+ [A helpful online toolkit](https://bookdown.org/andreabellavia/mixtures/preface.html) for mixtures analyses generated by Andrea Bellavia, PhD 

Some helpful mixtures case studies using BKMR include the following:

+ [Prenatal metal concentrations and childhood cardio-metabolic risk using Bayesian Kernel Machine Regression to assess mixture and interaction effects](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6402346/) 
+ [Associations between Phthalate Metabolite Concentrations in Follicular Fluid and Reproductive Outcomes among Women Undergoing in Vitro Fertilization/Intracytoplasmic Sperm Injection Treatment](https://ehp.niehs.nih.gov/doi/full/10.1289/EHP11998) 
+ [Associations of Prenatal Per- and Polyfluoroalkyl Substance (PFAS) Exposures with Offspring Adiposity and Body Composition at 16–20 Years of Age: Project Viva](https://ehp.niehs.nih.gov/doi/full/10.1289/EHP12597) 


<label class="tykfont">
Test Your Knowledge 
</label>

:::tyk

Using the simulated dataset within the bkmr package (see below code for how to call and store this dataset), answer the key environmental health questions using BKMR. 

1. Which of these chemicals has the strongest effect on the outcome?
2. Which of these chemicals increases the outome and which decreases the outcome?
3. What is the effect on the outcome with exposure to each of the chemicals individually?
4. What is the effect on the outcome associated with combined exposure to all chemicals?
5. Are there interactions among the chemicals relation to the outcome?

Note that the outcome (y) variable is a continuous variable here, rather than binary as in the scripted example. 
:::

```{r}
# Set seed for reproducibility
set.seed(111)

# Create a dataset with 100 participants and 4 mixtures components
data <- SimData(n = 100, M = 4)

# Save outcome variable (y)
y <- data$y

# Save mixtures variables (Z and X)
Z <- data$Z
X <- data$X
```
